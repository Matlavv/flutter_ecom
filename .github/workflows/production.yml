name: Production Build & Deploy

on:
    # DÃ©clenchement automatique sur les tags de version
    push:
        tags:
            - 'v*.*.*'

    # DÃ©clenchement manuel
    workflow_dispatch:
        inputs:
            version_name:
                description: 'Version name (ex: 1.0.1)'
                required: true
                default: '1.0.1'
            version_code:
                description: 'Version code (ex: 2)'
                required: true
                default: '2'

jobs:
    build-production-android:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: â˜• Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: 'zulu'
                  java-version: '17'

            - name: ğŸ¦ Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: '3.27.0'
                  channel: 'stable'

            - name: ğŸ“¦ Install dependencies
              run: flutter pub get

            - name: ğŸ§ª Run tests
              run: flutter test --coverage

            - name: ğŸ” Analyze code
              run: flutter analyze

            - name: ğŸ” Decode Android keystore
              env:
                  ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
              run: |
                  echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks

            - name: ğŸ“ Create key.properties
              env:
                  KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
                  KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
              run: |
                  echo "storePassword=$KEYSTORE_PASSWORD" > android/key.properties
                  echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
                  echo "keyAlias=upload" >> android/key.properties
                  echo "storeFile=upload-keystore.jks" >> android/key.properties

            - name: ğŸ—ï¸ Build production AAB
              run: |
                  flutter build appbundle --release \
                    --target-platform android-arm,android-arm64,android-x64 \
                    --build-name=${{ github.event.inputs.version_name || '1.0.0' }} \
                    --build-number=${{ github.event.inputs.version_code || github.run_number }}

            - name: ğŸ“± Upload AAB to artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: production-aab-${{ github.event.inputs.version_name || github.ref_name }}
                  path: build/app/outputs/bundle/release/app-release.aab
                  retention-days: 90

            - name: ğŸ“Š AAB Info
              run: |
                  echo "ğŸ‰ AAB de production gÃ©nÃ©rÃ© avec succÃ¨s !"
                  echo "ğŸ“± Fichier: app-release.aab"
                  echo "ğŸ“ Taille: $(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)"
                  echo "ğŸ” Signature: Production"
                  echo "ğŸ“¦ Package: com.matlav.flutter_ecom"
                  echo "ğŸ·ï¸ Version: ${{ github.event.inputs.version_name || github.ref_name }}"

    # Job pour prÃ©parer l'AAB pour upload manuel
    prepare-play-store-release:
        needs: build-production-android
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

        steps:
            - name: ğŸ“¥ Download AAB
              uses: actions/download-artifact@v4
              with:
                  name: production-aab-${{ github.ref_name }}

            - name: ğŸ“‹ Release Instructions
              run: |
                  echo "ğŸ‰ AAB de production prÃªt pour Google Play Store !"
                  echo ""
                  echo "ğŸ“± Fichier Ã  tÃ©lÃ©charger : app-release.aab"
                  echo "ğŸ“¦ Package : com.matlav.flutter_ecom"
                  echo "ğŸ·ï¸ Version : ${{ github.ref_name }}"
                  echo ""
                  echo "ğŸš€ Ã‰tapes pour publier :"
                  echo "1. TÃ©lÃ©chargez l'artifact 'production-aab-${{ github.ref_name }}'"
                  echo "2. Allez sur https://play.google.com/console"
                  echo "3. SÃ©lectionnez votre app 'Flutter Ecom'"
                  echo "4. Production â†’ CrÃ©er une version"
                  echo "5. Uploadez app-release.aab"
                  echo "6. Ajoutez les notes de version"
                  echo "7. Examiner et dÃ©ployer"
                  echo ""
                  echo "âœ… Votre app sera en ligne aprÃ¨s rÃ©vision Google (1-3 jours)"

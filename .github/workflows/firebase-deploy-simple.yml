name: 🔥 Firebase Deploy Simple

on:
    workflow_dispatch:
    push:
        branches: [main]

env:
    FLUTTER_VERSION: '3.24.5'
    PROJECT_ID: 'flutter-app-ecom'

jobs:
    deploy:
        name: 🚀 Deploy to Firebase
        runs-on: ubuntu-latest
        environment: production

        steps:
            - name: 📥 Checkout code
              uses: actions/checkout@v4

            - name: 🐦 Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: ${{ env.FLUTTER_VERSION }}
                  channel: 'stable'
                  cache: true

            - name: 📦 Get dependencies
              run: flutter pub get

            - name: 🧪 Run tests
              run: flutter test

            - name: 🔨 Build web
              run: flutter build web --release

            - name: 🔧 Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: 🔥 Setup Firebase CLI
              run: npm install -g firebase-tools

            - name: 🚀 Deploy to Firebase Hosting
              env:
                  GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/firebase-service-account.json
              run: |
                  echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > $GOOGLE_APPLICATION_CREDENTIALS

                  echo "🚀 Déploiement sur Firebase Hosting..."
                  firebase deploy --only hosting --project $PROJECT_ID

                  echo "✅ Déploiement terminé!"
                  echo "🌐 URL: https://$PROJECT_ID.web.app"

            - name: 📊 Summary
              run: |
                  echo "## 🎉 Déploiement Firebase réussi!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### 🔗 URL de production:" >> $GITHUB_STEP_SUMMARY
                  echo "https://$PROJECT_ID.web.app" >> $GITHUB_STEP_SUMMARY

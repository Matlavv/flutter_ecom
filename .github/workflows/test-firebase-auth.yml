name: 🧪 Test Firebase Authentication

on:
    workflow_dispatch:

env:
    PROJECT_ID: 'flutter-app-ecom'

jobs:
    test-auth:
        name: 🔐 Test Firebase Auth
        runs-on: ubuntu-latest

        steps:
            - name: 📥 Checkout code
              uses: actions/checkout@v4

            - name: 🔧 Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: 🔥 Setup Firebase CLI
              run: npm install -g firebase-tools

            - name: 🔐 Test Firebase Authentication
              env:
                  GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/firebase-service-account.json
              run: |
                  if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
                    echo "❌ ERREUR: Le secret FIREBASE_SERVICE_ACCOUNT n'est pas configuré"
                    echo "📋 Veuillez suivre les instructions dans setup-github-secrets.md"
                    exit 1
                  fi

                  echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > $GOOGLE_APPLICATION_CREDENTIALS

                  echo "🔍 Test de l'authentification Firebase..."
                  firebase projects:list --project $PROJECT_ID

                  echo "✅ Authentification Firebase réussie!"
                  echo "🎯 Projet: $PROJECT_ID"

                  echo "🔍 Test des permissions Hosting..."
                  firebase hosting:sites:list --project $PROJECT_ID

                  echo "✅ Permissions Firebase Hosting confirmées!"

            - name: 📊 Summary
              run: |
                  echo "## ✅ Test d'authentification Firebase réussi!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### 🎯 Projet testé:" >> $GITHUB_STEP_SUMMARY
                  echo "$PROJECT_ID" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ✅ Permissions vérifiées:" >> $GITHUB_STEP_SUMMARY
                  echo "- Firebase Projects: ✅" >> $GITHUB_STEP_SUMMARY
                  echo "- Firebase Hosting: ✅" >> $GITHUB_STEP_SUMMARY

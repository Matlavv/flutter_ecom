name: ðŸ”„ Firebase Blue-Green Deployment

on:
    push:
        branches: [main]
    workflow_dispatch:
        inputs:
            action:
                description: 'Action Ã  effectuer'
                required: true
                default: 'deploy'
                type: choice
                options:
                    - deploy
                    - rollback-blue
                    - rollback-green
                    - status

env:
    FLUTTER_VERSION: '3.24.5'
    PROJECT_ID: 'flutter-app-ecom'

jobs:
    prepare:
        name: ðŸ“‹ PrÃ©paration du dÃ©ploiement
        runs-on: ubuntu-latest
        outputs:
            active-channel: ${{ steps.channels.outputs.active }}
            inactive-channel: ${{ steps.channels.outputs.inactive }}
            should-deploy: ${{ steps.decision.outputs.should-deploy }}
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ”§ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: ðŸ”¥ Setup Firebase CLI
              run: |
                  npm install -g firebase-tools
                  echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > $HOME/firebase-service-account.json
                  export GOOGLE_APPLICATION_CREDENTIALS=$HOME/firebase-service-account.json
                  firebase --version

            - name: ðŸ” DÃ©terminer les channels actifs
              id: channels
              run: |
                  # Logique simplifiÃ©e pour dÃ©terminer le channel actif
                  # En production, vous pourriez vouloir une logique plus sophistiquÃ©e
                  TIMESTAMP=$(date +%s)
                  if [ $((TIMESTAMP % 2)) -eq 0 ]; then
                    echo "active=blue" >> $GITHUB_OUTPUT
                    echo "inactive=green" >> $GITHUB_OUTPUT
                  else
                    echo "active=green" >> $GITHUB_OUTPUT
                    echo "inactive=blue" >> $GITHUB_OUTPUT
                  fi

            - name: ðŸŽ¯ DÃ©cision de dÃ©ploiement
              id: decision
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    if [ "${{ github.event.inputs.action }}" = "deploy" ]; then
                      echo "should-deploy=true" >> $GITHUB_OUTPUT
                    else
                      echo "should-deploy=false" >> $GITHUB_OUTPUT
                    fi
                  else
                    echo "should-deploy=true" >> $GITHUB_OUTPUT
                  fi
    build:
        name: ðŸ”¨ Build Flutter Web
        runs-on: ubuntu-latest
        needs: prepare
        if: needs.prepare.outputs.should-deploy == 'true'
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ¦ Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: ${{ env.FLUTTER_VERSION }}
                  channel: 'stable'
                  cache: true

            - name: ðŸ“¦ Get dependencies
              run: flutter pub get

            - name: ðŸ§ª Run tests
              run: flutter test

            - name: ðŸ”¨ Build web
              run: |
                  flutter build web --release

            - name: ðŸ“¤ Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: web-build
                  path: build/web/
                  retention-days: 1

    deploy:
        name: ðŸš€ DÃ©ploiement Blue-Green
        runs-on: ubuntu-latest
        needs: [prepare, build]
        if: needs.prepare.outputs.should-deploy == 'true'
        environment: production
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ“¤ Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: web-build
                  path: build/web/

            - name: ðŸ”§ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: ðŸ”¥ Setup Firebase CLI
              run: |
                  npm install -g firebase-tools
                  echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > $HOME/firebase-service-account.json
                  export GOOGLE_APPLICATION_CREDENTIALS=$HOME/firebase-service-account.json

            - name: ðŸŽ¯ DÃ©ploiement sur channel inactif
              env:
                  GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/firebase-service-account.json
              run: |
                  echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > $GOOGLE_APPLICATION_CREDENTIALS

                  INACTIVE_CHANNEL="${{ needs.prepare.outputs.inactive-channel }}"
                  echo "ðŸš€ DÃ©ploiement sur le channel: $INACTIVE_CHANNEL"

                  firebase deploy --only hosting:$INACTIVE_CHANNEL --project $PROJECT_ID

                  # Stocker l'URL du channel pour les tests
                  CHANNEL_URL="https://$PROJECT_ID--$INACTIVE_CHANNEL-$(echo $PROJECT_ID | tr '[:upper:]' '[:lower:]').web.app"
                  echo "CHANNEL_URL=$CHANNEL_URL" >> $GITHUB_ENV
                  echo "INACTIVE_CHANNEL=$INACTIVE_CHANNEL" >> $GITHUB_ENV

            - name: ðŸ§ª Smoke Tests
              run: |
                  echo "ðŸ§ª ExÃ©cution des smoke tests sur: $CHANNEL_URL"

                  # Test 1: VÃ©rifier que l'application se charge
                  STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$CHANNEL_URL" || echo "000")
                  if [ "$STATUS_CODE" != "200" ]; then
                    echo "âŒ Smoke test Ã©chouÃ©: Status code $STATUS_CODE"
                    exit 1
                  fi
                  echo "âœ… Test 1 rÃ©ussi: Application accessible (200)"

                  # Test 2: VÃ©rifier le contenu Flutter
                  CONTENT=$(curl -s "$CHANNEL_URL" || echo "")
                  if [[ ! "$CONTENT" == *"flutter"* ]]; then
                    echo "âŒ Smoke test Ã©chouÃ©: Contenu Flutter non trouvÃ©"
                    exit 1
                  fi
                  echo "âœ… Test 2 rÃ©ussi: Contenu Flutter dÃ©tectÃ©"

                  # Test 3: VÃ©rifier les assets critiques
                  MAIN_JS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$CHANNEL_URL/main.dart.js" || echo "000")
                  if [ "$MAIN_JS_STATUS" = "200" ]; then
                    echo "âœ… Test 3 rÃ©ussi: Assets JavaScript accessibles"
                  else
                    echo "âš ï¸ Attention: main.dart.js non accessible (status: $MAIN_JS_STATUS)"
                  fi

                  echo "ðŸŽ‰ Tous les smoke tests sont rÃ©ussis!"

            - name: ðŸ”„ Promotion vers Live
              env:
                  GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/firebase-service-account.json
              run: |
                  echo "ðŸ”„ Promotion du channel $INACTIVE_CHANNEL vers live"

                  firebase hosting:clone $PROJECT_ID:$INACTIVE_CHANNEL $PROJECT_ID:live --project $PROJECT_ID

                  echo "âœ… Promotion rÃ©ussie!"
                  echo "ðŸŒ URL Live: https://$PROJECT_ID.web.app"
                  echo "ðŸ”µ URL Blue: https://$PROJECT_ID--blue-$(echo $PROJECT_ID | tr '[:upper:]' '[:lower:]').web.app"
                  echo "ðŸŸ¢ URL Green: https://$PROJECT_ID--green-$(echo $PROJECT_ID | tr '[:upper:]' '[:lower:]').web.app"

            - name: ðŸ“Š RÃ©sumÃ© du dÃ©ploiement
              run: |
                  echo "## ðŸŽ‰ DÃ©ploiement Blue-Green rÃ©ussi!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸ“‹ DÃ©tails:" >> $GITHUB_STEP_SUMMARY
                  echo "- **Channel dÃ©ployÃ©:** $INACTIVE_CHANNEL" >> $GITHUB_STEP_SUMMARY
                  echo "- **Status:** âœ… SuccÃ¨s" >> $GITHUB_STEP_SUMMARY
                  echo "- **Smoke tests:** âœ… RÃ©ussis" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸ”— URLs:" >> $GITHUB_STEP_SUMMARY
                  echo "- **Production:** https://$PROJECT_ID.web.app" >> $GITHUB_STEP_SUMMARY
                  echo "- **Blue Channel:** https://$PROJECT_ID--blue-$(echo $PROJECT_ID | tr '[:upper:]' '[:lower:]').web.app" >> $GITHUB_STEP_SUMMARY
                  echo "- **Green Channel:** https://$PROJECT_ID--green-$(echo $PROJECT_ID | tr '[:upper:]' '[:lower:]').web.app" >> $GITHUB_STEP_SUMMARY

    rollback:
        name: ðŸ”™ Rollback
        runs-on: ubuntu-latest
        needs: prepare
        if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'rollback-blue' || github.event.inputs.action == 'rollback-green')
        environment: production
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ”§ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: ðŸ”¥ Setup Firebase CLI
              run: |
                  npm install -g firebase-tools
                  echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > $HOME/firebase-service-account.json

            - name: ðŸ”™ ExÃ©cuter le rollback
              env:
                  GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/firebase-service-account.json
              run: |
                  echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > $GOOGLE_APPLICATION_CREDENTIALS

                  if [ "${{ github.event.inputs.action }}" = "rollback-blue" ]; then
                    TARGET_CHANNEL="blue"
                  else
                    TARGET_CHANNEL="green"
                  fi

                  echo "ðŸ”™ Rollback vers le channel: $TARGET_CHANNEL"
                  firebase hosting:clone $PROJECT_ID:$TARGET_CHANNEL $PROJECT_ID:live --project $PROJECT_ID

                  echo "âœ… Rollback rÃ©ussi vers $TARGET_CHANNEL"

    status:
        name: ðŸ“Š Status des channels
        runs-on: ubuntu-latest
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'status'
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ”§ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: ðŸ”¥ Setup Firebase CLI
              run: |
                  npm install -g firebase-tools
                  echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > $HOME/firebase-service-account.json

            - name: ðŸ“Š Afficher le status
              env:
                  GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/firebase-service-account.json
              run: |
                  echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > $GOOGLE_APPLICATION_CREDENTIALS

                  echo "ðŸ“Š Status des channels Firebase Hosting:"
                  firebase hosting:channel:list --project $PROJECT_ID

                  echo ""
                  echo "ðŸ”— URLs disponibles:"
                  echo "- Production: https://$PROJECT_ID.web.app"
                  echo "- Blue: https://$PROJECT_ID--blue-$(echo $PROJECT_ID | tr '[:upper:]' '[:lower:]').web.app"
                  echo "- Green: https://$PROJECT_ID--green-$(echo $PROJECT_ID | tr '[:upper:]' '[:lower:]').web.app"

name: ğŸš€ CI/CD Firebase Blue-Green

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:
        inputs:
            action:
                description: 'Action Ã  effectuer'
                required: true
                default: 'deploy'
                type: choice
                options:
                    - deploy
                    - rollback-blue
                    - rollback-green
                    - status

env:
    FLUTTER_VERSION: '3.24.5'
    JAVA_VERSION: '17'
    PROJECT_ID: 'flutter-app-ecom'

jobs:
    test:
        name: ğŸ§ª Tests
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ¦ Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: ${{ env.FLUTTER_VERSION }}
                  channel: 'stable'
                  cache: true

            - name: ğŸ“¦ Get dependencies
              run: flutter pub get

            - name: ğŸ” Analyze code
              run: flutter analyze

            - name: ğŸ§ª Run tests
              run: flutter test --coverage

            - name: ğŸ“Š Upload coverage
              uses: codecov/codecov-action@v4
              if: success()
              with:
                  file: coverage/lcov.info
                  token: ${{ secrets.CODECOV_TOKEN }}
                  fail_ci_if_error: false

    build-web:
        name: ğŸŒ Build Web
        runs-on: ubuntu-latest
        needs: test
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ¦ Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: ${{ env.FLUTTER_VERSION }}
                  channel: 'stable'
                  cache: true

            - name: ğŸ“¦ Get dependencies
              run: flutter pub get

            - name: ğŸ”¨ Build web
              run: flutter build web --release --web-renderer canvaskit

            - name: ğŸ“¤ Upload web build
              uses: actions/upload-artifact@v4
              with:
                  name: web-build
                  path: build/web/
                  retention-days: 7

    build-android:
        name: ğŸ¤– Build Android
        runs-on: ubuntu-latest
        needs: test
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: â˜• Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: 'zulu'
                  java-version: ${{ env.JAVA_VERSION }}

            - name: ğŸ¦ Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: ${{ env.FLUTTER_VERSION }}
                  channel: 'stable'
                  cache: true

            - name: ğŸ“¦ Get dependencies
              run: flutter pub get

            - name: ğŸ”¨ Build AAB
              run: flutter build appbundle --release --target-platform android-arm64
            - name: ğŸ“¤ Upload AAB
              uses: actions/upload-artifact@v4
              with:
                  name: android-aab
                  path: build/app/outputs/bundle/release/app-release.aab
                  retention-days: 7

    deploy:
        name: ğŸš€ Deploy to Firebase
        runs-on: ubuntu-latest
        needs: [test, build-web]
        if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy'))
        environment: production
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ“¤ Download web build
              uses: actions/download-artifact@v4
              with:
                  name: web-build
                  path: build/web/

            - name: ğŸ”§ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: ğŸ”¥ Setup Firebase CLI
              run: npm install -g firebase-tools

            - name: ğŸ¯ Determine deployment channel
              id: channel
              run: |
                  # Simple logic: use timestamp to alternate between blue and green
                  TIMESTAMP=$(date +%s)
                  if [ $((TIMESTAMP % 2)) -eq 0 ]; then
                    echo "channel=blue" >> $GITHUB_OUTPUT
                    echo "other_channel=green" >> $GITHUB_OUTPUT
                  else
                    echo "channel=green" >> $GITHUB_OUTPUT
                    echo "other_channel=blue" >> $GITHUB_OUTPUT
                  fi
                  echo "Deploying to channel: $(cat $GITHUB_OUTPUT | grep channel= | head -1 | cut -d= -f2)"

            - name: ğŸš€ Deploy to preview channel
              env:
                  FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
              run: |
                  CHANNEL="${{ steps.channel.outputs.channel }}"
                  echo "ğŸš€ Deploying to channel: $CHANNEL"

                  firebase hosting:channel:deploy $CHANNEL \
                    --project $PROJECT_ID \
                    --expires 30d \
                    --token $FIREBASE_TOKEN

            - name: ğŸ§ª Run smoke tests
              id: smoke_tests
              run: |
                  CHANNEL="${{ steps.channel.outputs.channel }}"
                  PREVIEW_URL="https://$PROJECT_ID--$CHANNEL-$(echo $PROJECT_ID | tr '[:upper:]' '[:lower:]' | tr '-' '').web.app"

                  echo "ğŸ§ª Running smoke tests on: $PREVIEW_URL"

                  # Wait for deployment to be ready
                  sleep 30

                  # Test 1: Check if site is accessible
                  STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL" || echo "000")
                  if [ "$STATUS_CODE" != "200" ]; then
                    echo "âŒ Smoke test failed: Status code $STATUS_CODE"
                    echo "smoke_tests_passed=false" >> $GITHUB_OUTPUT
                    exit 1
                  fi
                  echo "âœ… Site is accessible (200)"

                  # Test 2: Check for Flutter content
                  CONTENT=$(curl -s "$PREVIEW_URL" || echo "")
                  if [[ ! "$CONTENT" == *"flutter"* ]] && [[ ! "$CONTENT" == *"Flutter"* ]]; then
                    echo "âŒ Smoke test failed: Flutter content not found"
                    echo "smoke_tests_passed=false" >> $GITHUB_OUTPUT
                    exit 1
                  fi
                  echo "âœ… Flutter content detected"

                  echo "ğŸ‰ All smoke tests passed!"
                  echo "smoke_tests_passed=true" >> $GITHUB_OUTPUT
                  echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

            - name: ğŸ”„ Promote to live
              if: steps.smoke_tests.outputs.smoke_tests_passed == 'true'
              env:
                  FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
              run: |
                  CHANNEL="${{ steps.channel.outputs.channel }}"
                  echo "ğŸ”„ Promoting channel $CHANNEL to live"

                  firebase hosting:clone $PROJECT_ID:$CHANNEL $PROJECT_ID:live \
                    --project $PROJECT_ID \
                    --token $FIREBASE_TOKEN

                  echo "âœ… Successfully promoted to live!"

            - name: ğŸ“Š Deployment summary
              if: always()
              run: |
                  echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Channel**: ${{ steps.channel.outputs.channel }}" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ steps.smoke_tests.outputs.smoke_tests_passed }}" = "true" ]; then
                    echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
                    echo "- **Live URL**: https://$PROJECT_ID.web.app" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "- **Status**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ğŸ”— URLs:" >> $GITHUB_STEP_SUMMARY
                  echo "- **Production**: https://$PROJECT_ID.web.app" >> $GITHUB_STEP_SUMMARY
                  echo "- **Preview**: ${{ steps.smoke_tests.outputs.preview_url }}" >> $GITHUB_STEP_SUMMARY

    rollback:
        name: ğŸ”™ Rollback
        runs-on: ubuntu-latest
        if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'rollback-blue' || github.event.inputs.action == 'rollback-green')
        environment: production
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ”§ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: ğŸ”¥ Setup Firebase CLI
              run: npm install -g firebase-tools

            - name: ğŸ”™ Execute rollback
              env:
                  FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
              run: |
                  if [ "${{ github.event.inputs.action }}" = "rollback-blue" ]; then
                    TARGET_CHANNEL="blue"
                  else
                    TARGET_CHANNEL="green"
                  fi

                  echo "ğŸ”™ Rolling back to channel: $TARGET_CHANNEL"

                  firebase hosting:clone $PROJECT_ID:$TARGET_CHANNEL $PROJECT_ID:live \
                    --project $PROJECT_ID \
                    --token $FIREBASE_TOKEN

                  echo "âœ… Rollback completed successfully"
                  echo "ğŸŒ Live URL: https://$PROJECT_ID.web.app"

    status:
        name: ğŸ“Š Channel Status
        runs-on: ubuntu-latest
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'status'
        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ”§ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: ğŸ”¥ Setup Firebase CLI
              run: npm install -g firebase-tools

            - name: ğŸ“Š Show channel status
              env:
                  FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
              run: |
                  echo "ğŸ“Š Firebase Hosting Channels Status:"
                  firebase hosting:channel:list --project $PROJECT_ID --token $FIREBASE_TOKEN

                  echo ""
                  echo "ğŸ”— Available URLs:"
                  echo "- Production: https://$PROJECT_ID.web.app"
                  echo "- Blue Channel: https://$PROJECT_ID--blue-$(echo $PROJECT_ID | tr '[:upper:]' '[:lower:]' | tr '-' '').web.app"
                  echo "- Green Channel: https://$PROJECT_ID--green-$(echo $PROJECT_ID | tr '[:upper:]' '[:lower:]' | tr '-' '').web.app"
